image: python:3.11


stages:
  - test
  - build
  - push


variables:
  GITLAB_REGISTRY_URL: "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/packages/pypi"
  PACKAGE_VERSION: "0.1.${CI_PIPELINE_IID}"


before_script:
  - pip install --upgrade pip


mypy:
  stage: test
  before_script:
    - pip install -r requirements.txt
  script:
    - pip freeze
    - mypy proxmoxtemplates


build:
  stage: build
  before_script:
    - export $PACKAGE_VERSION
    - echo "Setting package version to $PACKAGE_VERSION"
  script:
    - pip install build
    - python setup.py sdist bdist_wheel
  artifacts:
    paths:
      - dist/*.whl
      - dist/*.tar.gz


deploy:
  stage: push
  script:
    - pip install twine
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url $GITLAB_REGISTRY_URL dist/* --verbose
